## 웹서버와 웹 애플리케이션
- 웹은 HTTP 기반으로 이루어져있습니다. 
- 음성 영상, 파일등 JSON도 거의 모든 형태의 데이터를 주고 받을 때도 모두 HTTP를 사용합니다.
## 웹 서버 
- HTTP 기반으로 동작하는 서버
- 정적 리소스와 기타 부가기능을 제공함
  - 정적 리소스 : HTML, CSS, JS, 이미지, 영상등을 모아둡니다.
  - NGINX, APACHE 등이 존재합니다.
## 웹 애플리케이션 서버(WAS - Web Application Server)
- HTTP 기반으로 동작을 합니다. 
- 웹 서버 기능을 포함 하고, 추가적으로 **정적 리소스도 제공이 가능하빈다.**
- 프로그램 코드를 실행해서 애플리케이션 로직을 수행합니다. 
  - 동적 HTML, HTTP API (JSON)
  - 서블릿, JSP, 스프링 MVC
- 톰캣(Tomcat) Jetty, Undertow
## 웹 서버와 웹 애플리케이션 서버의 차이
- 웹 서버는 정정 리소스 , WAS는 애플리케이션 로직
  - 서로는 서로의 기능을 포함하기도함
- 자바는 서블릿 컨테이너 기능을 제공하면, WAS
- **WAS는 애플리케이션 코드를 실행하는데 더 특화되어 있다고 보면 됩니다.**
## 웹 시스템 구성 - WAS, DB
- 우리는 웹 시스템을 WAS와 DB만으로도 시스템을 구성할 수 있습니다. 
- 하지만, 이러면, WAS가 너무 많은 역할을 담당해, 서버가 과부화 됩니다. 
- **HTML, CSS등은 싸지만, 애플리케이션 로직은 비싼데, 정적 리소스 때문에 수행이 어려워 질 수도 있음**
- WAS는 잘 죽기 때문에, 장애가 일어나면, 오류 화면도 노출이 불가능합니다.
## 웹 시스템 구성 - WEB, WAS, DB
- 정적 리소스는 WEB 서버가 처리를 합니다
- 웹 서버는 애플리케이션 로직을 처리할 때, WAS에 요청을 위임합니다. 
  - 결국, WAS가 중요한 로직을 처리합니다. 
- 이는, 효율적인 리소스 관리가 가능합니다.
  - 정적 리소스가 많이 사용된다면, Web 서버를 증설합니다. 
  - 애플리케이션 리소스가 많이 사용된다면 WAS를 증설합니다. 
- 또한, 웹 서버는 정적 리소스만 제공하기 때문에 잘 죽지 않습니다. 
  - 하지만, WAS는 애플리 케이션 로직이 동작하기 때문에 쉽게 죽습니다.
  - 그래도, Web서버는 죽지 않았으므로, WEB서버는 오류 화면을 제공할 수 있습니다. 
---
## 서블릿
- 웹 브라우저는 POST 전송을 하면, HTTP 메세지를 클라이언트에게 보냅니다. 
  - Conent-Type: application/x-www-form-urlencoded로 전달합니다. 
- 이외에 여러가지 응답을 넣어야하는데, 파싱을해서 넣는 것도 힘들고, 응답 메세지는 결국 text이므로, 값을 가져오는것도 힘들다
- 서블릿은 그래서, 응답 메세지 생성, 부터 여러가지 일들을 다 해줍니다.
### 특징
```java
@WebServlet(name = "helloServlet", urlPatterns = "/hello")
public class HelloServlet extends HttpServlet {
  @Override 
  protected void service(HttpservletRequest request, HttpServletResponse response) {ㅎ
    // 애플리케이션 로직
  }
}
```
- `urlPatterns(/hello)`의 url이 호출된다면 서블릿의 코드가 실행이 됩니다. 
- 우리는 요청 정보를 `HttpServletRequest`, 응답 정보를 `HttpServletResponse`를 통해서, 쉽게 사용을 할 수있습니다. 
- 우리는 이러한 것을 통해서 HTTP 스펙을 매우 편리하게 사용이 가능합니다. 
### HTTP 요청, 응답 흐름
- HTTP 요청이 온다면
  - WAS는 Request, Response 객체를 새로 만들어서 서블릿 객체를 호출하빈다. 
  - 개발자는 Request 객체에서 HTTP 요청 정보를 편하게 꺼내서 사용가능하빈다. 또한, 응답도 마찬가지 입니다. 
  - WAS는 Response 객체에 담겨있는 내용을 통해 HTTP 응답 정보를 생성합니다. 
  - 이러한 Servlet 객체는 WAS안에 있는 **서블릿 컨테이너**가 생성하고 호출, 관리까지 진행합니다. 
### 서블릿 컨테이너
- 톰캣과 같이 Servlet을 지원하는 WAS를 **서블릿 컨테이너**라고 부릅니다. 
- 이는, 서블릿 객체를 생성 -> 초기화 -> 호출 -> 종료 하는 생명주기를 관리합니다. 
- 이들의 객체는 **싱글톤으로 관리 됩니다**
  - 그래서, 최초의 로딩 시점에서 미리 만들어 두고 재활용합니다. 
  - 결국 모든 고객의 요청은 동일한 서블릿 객체 인스턴스에 접근하게 됩니다. 
  - **그렇기 때문에 공유 변수 사용에 주의 해야합니다.**
- JSP도 서블릿으로 변환되어서 사용됩니다. 
- 동시요청을 위한 **멀티 쓰레드 처리**를 지원합니다.
---
## 동시 요청 - 멀티 쓰레드 
- 한명이, 요청을 하면, WAS가 Servlet을 호출할 때, **쓰레드**가 호출을 합니다. 
### 쓰레드 
- 애플리케이션 코드를 하나하나 순차적으로 실행하는 것을 쓰레드 입니다. 
- 쓰레드가 없으면, 자바 애플리케이션을 실행이 불가능 합니다. 
  - 왜냐하면, 자바의 main메서드를 처음 실행하면, main이라는 이름의 쓰레드가 생성되기 때문이빈다. 
- 이런, 쓰레드는 한번에 하나의 코드 라인만 수행합니다. 
- 동시처리가 필요하면, 쓰레드를 추가로 생성합니다. 
- 이러한, 쓰레드는 요청할때마다, 신규 쓰레드르 생성해, 고객의 요청에 응답합니다.
### 요청 마다 쓰레드 생성의 장단점
- 장점
  - 동시 요청을 처리가능합니다. 
  - 리소스가 허락을 한다면, 계속 처리가 가능합니다.
  - 하나가 지연되도 나머시 쓰레드를 생성하므로, 나머지는 정상동작 합니다. 
- 단점
  - 쓰레드 생성 비용은 매우 비쌉니다. 
    - 고객의 요청이 올때마다, 생성한다면, 응답 속도가 느려집니다. 
  - 쓰레드는 Context Switching 비용이 발생합니다. 
  - 쓰레드 생성에 제한이 없어, 고객의 요청이 많으면, CPU와 메모리 임계점을 넘어 서버가 죽을수도 있습니다. 
### 쓰레드 풀
- 위의 단점을 해결하기 위해, 미리 쓰레드를 생성을 해두고, 이를 가져다 쓰는 방식을 사용합니다.
  - 응답이 끝난, 쓰레드는 다시 쓰레드 풀에 반환합니다. 
- 미리 쓰레드를 생성한 곳을 **쓰레드 풀**이라고 합니다.
### 쓰레드 풀의 특징
- 특징
  - 필요한 쓰레드를 쓰레드 풀에 보관하고 관리합니다. 
  - 쓰레드 풀에 생성가능한 쓰레드의 최대치를 관리합니다. 
    - 톰캣은 기본적으로 **최대 200개**를 가집니다. 
- 사용
  - 요청시, 쓰레드 풀에서 쓰레드를 꺼내 사용합니다. 
  - 사용이 끝나면, 쓰레드 풀에 반납합니다. 
  - 사용가능한 쓰레드가 없다면, 요청을 거정하거나 특정 숫자 만큼 대기하도록 할 수 있습니다. 
- 장점
  - 쓰레드가 미리 생성되어있어, 쓰레드를 생성하고 종료하는 비용이 절약되고, 응답이 빠릅니다. 
  - 생성 가능한 쓰레드의 최대가 있어, 기존 요청을 안전하게 처리 가능합니다.
### 실무 팁
- WAS에서 중요한 것은 결국 **최대 쓰레드 갯수입니다.**
  - 너무 낮으면, 서버 리소스는 여유로운데 클라이언트에서 지연이 많이 발생합니다. 
  - 너무 높으면, CPU, 메모리 리소스 임계점 초과로 서버가 다운됩니다. 
- 그래서, 장애가 발생하면 다음과 같이 행동합니다. 
  - 클라우드면, 서버를 늘리고, 이후 튜닝합니다. 
  - 클라우드가 아니면, 열심히, 쓰레드 갯수를 튜닝합니다. 
### 쓰레드 풀의 적정 숫자
- 적정 숫자는, 애플리케이션의 복잡도, CPU, 메모리 등에 따라 모두 다릅니다. 
- 그래서 우리는 최대한 실제 서비스와 비슷하게 성능 테스트를 미리 합니다. 
  - 툴 : 아파치 ab, Jmeter, nGrinder등을 사용합니다. 
### 핵심
- 우리는 WAS를 쓰면서 멀티 쓰레드 관련 코드를 신경안써도 됩니다. 
- 싱글 쓰레드를 프로그래밍 하듯이 편하게 소스 코드를 개발하면 됩니다. 
- 하지만, **멀티 쓰레드 환경이기 때문에 싱글톤 객체들은 주의해서 사용을 해야합니다.**
---
### 정적 리소스
- 고정된 HTML, CSS, JS 이미지등을 줍니다.
### HTML 페이지
- 동적으로 필요한 HTML 파일을 생성해서 전달하고, 이를 웹 브라우저가 해석합니다.
  - JSP, 타임리프등이 생성합니다.
### HTTP API
- HTML이 아닌 데이터를 주로 `JSON`형식을 사용해서 보냅니다.
- 이들은 다양한 시스템에서 호출이 됩니다.
- 데이터만 주고 받기 때문에, UI 화면이 필요하다면, 클라이언트가 별도로 처리합니다.
- 보통, UI 클라이언트, 서버 to 서버등과 JSON 형태로 데이터를 통신합니다.
## 서버사이드 렌더링, 클라이언트 사이드 렌더링
### SSR - 서버 사이드 렌더링
- HTML 최종 결과를 서버에서 만들고 웹 브라우저에게 전달합니다.
- 주로, 정적인 화면에서 사용이 됩니다.
- 백엔드 개발자가 주요 사용합니다. (JSP, 타임리프등)
### CSR - 클라이언트 사이드 렌더링
- HTML 결과를 자바스크립트를 사용해서 웹 브라우저에서 동적으로 생성을 합니다.
- 동적인 화면에 사용하여, 앱처럼 필요한 부분들을 부분부분 변경이 가능합니다.
  - 구글 지도, Gmail 등에서 사용합니다.
- React, Vue.js 등 웹 프론트엔드 개발자가 사용합니다.
### 참고사항
- SSR를 써도, 자바스크립트를 사용해서, 일부 화면을 동적으로 변경이 가능합니다.
- 또한, SSR과 CSR을 동시에 지원하는 프레임워크도 존재합니다.
---